<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Test - Telegram Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover { background: #006699; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .telegram-widget-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
        }
        .step {
            border-left: 4px solid #0088cc;
            padding-left: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Production Test - Telegram Login</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç production –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Login Widget.
            –ù–∞ localhost —Ä–µ–∞–ª—å–Ω—ã–π Telegram Widget –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º—ã –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.
        </div>
        
        <div id="status"></div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
            
            <button class="btn" onclick="checkEnvironment()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn" onclick="testAPI()">–¢–µ—Å—Ç API</button>
            <button class="btn" onclick="loadTelegramWidget()">–ó–∞–≥—Ä—É–∑–∏—Ç—å Telegram Widget</button>
            
            <div id="environment-results"></div>
        </div>

        <div class="container">
            <h2>üì± Telegram Widget Test</h2>
            
            <div class="telegram-widget-container" id="telegram-container">
                <p>–ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è Telegram Login Widget</p>
                <p><small>–ù–∞ localhost Widget –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–∫—Ä–∏–ø—Ç –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è</small></p>
            </div>
            
            <div id="widget-status"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è production</h2>
        
        <div class="step">
            <h3>–®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ BotFather</h3>
            <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram ‚Üí @BotFather</p>
            <p>2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: <code>/setdomain</code></p>
            <p>3. –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞: <code>@Hrc_staff_adm_bot</code></p>
            <p>4. –£–∫–∞–∂–∏—Ç–µ –¥–æ–º–µ–Ω: <code>horecapp.netlify.app</code></p>
        </div>
        
        <div class="step">
            <h3>–®–∞–≥ 2: –î–µ–ø–ª–æ–π –Ω–∞ Netlify</h3>
            <p>1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∞–ø–∫—É <code>dist/</code> –Ω–∞ Netlify</p>
            <p>2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–æ–º–µ–Ω <code>horecapp.netlify.app</code></p>
            <p>3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Netlify</p>
        </div>
        
        <div class="step">
            <h3>–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ <code>https://horecapp.netlify.app/auth</code></p>
            <p>2. –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram"</p>
            <p>3. –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Telegram</p>
        </div>
    </div>

    <div class="container">
        <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h2>
        <div id="results"></div>
    </div>

    <script>
        let widgetLoaded = false;

        function addStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            status.appendChild(div);
        }

        function addResult(title, data, containerId = 'results') {
            const results = document.getElementById(containerId);
            const div = document.createElement('div');
            div.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            results.appendChild(div);
        }

        async function checkEnvironment() {
            addStatus('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º production –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                const appResponse = await fetch('http://localhost:4000/');
                const appOk = appResponse.ok;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Edge Functions
                const functionsTest = await fetch('https://kuyudpxqlrinkcxvorom.supabase.co/functions/v1/telegram-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                const envData = {
                    production_mode: 'VITE_USE_DEMO_MODE=false',
                    app_accessible: appOk,
                    edge_functions_accessible: functionsTest.status !== 0,
                    bot_username: 'Hrc_staff_adm_bot',
                    supabase_url: 'https://kuyudpxqlrinkcxvorom.supabase.co',
                    expected_domain: 'horecapp.netlify.app',
                    current_location: window.location.href
                };
                
                addResult('Production Environment', envData, 'environment-results');
                
                if (appOk) {
                    addStatus('‚úÖ Production build –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                } else {
                    addStatus('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å production build', 'error');
                }
                
            } catch (error) {
                addStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            addStatus('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º API –≤ production —Ä–µ–∂–∏–º–µ...', 'info');
            
            try {
                // –¢–µ—Å—Ç —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º hash (–æ–∂–∏–¥–∞–µ–º –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
                const response = await fetch('https://kuyudpxqlrinkcxvorom.supabase.co/functions/v1/telegram-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1eXVkcHhxbHJpbmtjeHZvcm9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY4NTYyNDAsImV4cCI6MjA1MjQzMjI0MH0.Xr0gLu29YWtfFe9MK4cLUfbHYcQhxV_W1IiT8mB3TWA'
                    },
                    body: JSON.stringify({
                        id: 123456789,
                        first_name: 'Test',
                        last_name: 'User',
                        username: 'testuser',
                        auth_date: Math.floor(Date.now() / 1000),
                        hash: 'invalid_hash_for_testing'
                    })
                });
                
                const data = await response.json();
                
                addResult('API Test Response', {
                    status: response.status,
                    response: data
                });
                
                if (response.status === 401) {
                    addStatus('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ª—É—á–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)', 'success');
                } else if (response.status === 400) {
                    addStatus('‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç)', 'success');
                } else {
                    addStatus(`‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç API: ${response.status}`, 'warning');
                }
                
            } catch (error) {
                addStatus(`‚ùå –û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                addResult('API Error', error);
            }
        }

        function loadTelegramWidget() {
            addStatus('üì± –ó–∞–≥—Ä—É–∂–∞–µ–º Telegram Widget...', 'info');
            
            try {
                const container = document.getElementById('telegram-container');
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ Telegram Widget...</p>';
                
                // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram Widget
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://telegram.org/js/telegram-widget.js?22';
                script.setAttribute('data-telegram-login', 'Hrc_staff_adm_bot');
                script.setAttribute('data-size', 'large');
                script.setAttribute('data-corner-radius', '20');
                script.setAttribute('data-request-access', 'write');
                script.setAttribute('data-userpic', 'true');
                script.setAttribute('data-lang', 'ru');
                script.setAttribute('data-onauth', 'onTelegramAuth(user)');
                
                // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è callback
                window.onTelegramAuth = function(user) {
                    addStatus('üéâ Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞!', 'success');
                    addResult('Telegram User Data', user, 'widget-status');
                };
                
                script.onload = function() {
                    addStatus('‚úÖ Telegram Widget —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                    widgetLoaded = true;
                    
                    const widgetStatus = document.getElementById('widget-status');
                    widgetStatus.innerHTML += '<div class="info">–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –≤–∏–¥–∂–µ—Ç –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ localhost</div>';
                };
                
                script.onerror = function() {
                    addStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Telegram Widget', 'error');
                    const widgetStatus = document.getElementById('widget-status');
                    widgetStatus.innerHTML += '<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–ø—Ç Telegram</div>';
                };
                
                container.appendChild(script);
                
            } catch (error) {
                addStatus(`‚ùå –û—à–∏–±–∫–∞ Telegram Widget: ${error.message}`, 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            addStatus('üöÄ Production —Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω', 'info');
            checkEnvironment();
        };
    </script>
</body>
</html>
