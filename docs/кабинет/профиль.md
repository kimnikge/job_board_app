
# Техническое задание: Система бейджей, геймификации и видео-портфолио кандидата

## 1. Краткое описание и цель

Вместо традиционного текстового резюме профиль кандидата становится интерактивной карточкой с видео-презентацией, шкалами навыков, лентой опыта и системой бейджей. Бейджи — ключевой элемент геймификации, отражающий достижения, soft и hard skills, а также рекомендации и оценки работодателей.

**Цели:**
- Повысить вовлечённость и мотивацию кандидатов.
- Упростить и ускорить оценку соискателей работодателями.
- Сделать профиль визуально насыщенным, современным и понятным молодым поколениям.

## 2. Пользователи и роли

- **Кандидат** — получает бейджи, ведёт портфолио, видит свои достижения.
- **Работодатель** — вручает бейджи сотрудникам, формирует собственные категории бейджей, просматривает профили.
- **Администратор** — управляет глобальными категориями, модерацией, массовыми операциями.

## 3. Концепция уровней и категорий бейджей

Бейджи делятся на:
- **Категории**: Hard Skills, Soft Skills, Опыт, Рекомендации, Спецпроекты, Лояльность, Вклад в команду, Прочее.
- **Уровни**: Bronze, Silver, Gold, Platinum (визуально различаются цветом и/или рамкой).

**Примеры категорий и уровней:**
- Hard Skills: “Barista”, “Mixology” (Bronze/Silver/Gold)
- Soft Skills: “Team Player”, “Punctuality”
- Опыт: “50 Shifts”, “Night Owl”
- Рекомендации: “Recommended by Employer”

## 4. Структура бейджей с примерами

**Бейдж** — сущность с метаданными:
- id, name, description, icon_url (SVG), category, level, is_company_generated, company_id, created_at, updated_at

**Пример:**
```json
{
  "id": "uuid",
  "name": "Barista Gold",
  "description": "Достигнут уровень Gold в навыке Barista",
  "icon_url": "https://cdn/app/badges/barista_gold.svg",
  "category": "Hard Skills",
  "level": "Gold",
  "is_company_generated": false,
  "company_id": null,
  "created_at": "2024-06-01T12:00:00Z"
}
```

**Присвоение бейджа пользователю:**
- id, badge_id, user_id, employer_id, awarded_by, awarded_at, reason, source (manual/auto), work_log_id (опционально)

## 5. Подробное описание базы данных с SQL-схемами

**Таблица `badges`:**
```sql
create table badges (
  id uuid primary key,
  name text not null,
  description text,
  icon_url text not null,
  category text not null,
  level text,
  is_company_generated boolean default false,
  company_id uuid references employers(id),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

**Таблица `user_badges`:**
```sql
create table user_badges (
  id uuid primary key,
  badge_id uuid references badges(id) not null,
  user_id uuid references users(id) not null,
  employer_id uuid references employers(id),
  awarded_by uuid references users(id),
  awarded_at timestamptz default now(),
  reason text,
  source text check (source in ('manual','auto')),
  work_log_id uuid references work_logs(id)
);
```

**Таблица `skills`:**
```sql
create table skills (
  id uuid primary key,
  user_id uuid references users(id) not null,
  name text not null,
  level int default 0, -- 0-100
  category text,
  updated_at timestamptz default now()
);
```

**Таблица `employers`:**
```sql
create table employers (
  id uuid primary key,
  name text not null,
  logo_url text
);
```

**Таблица `work_logs`:**
```sql
create table work_logs (
  id uuid primary key,
  user_id uuid references users(id),
  employer_id uuid references employers(id),
  start_date date,
  end_date date,
  shifts_count int,
  total_hours int
);
```

## 6. Механика выдачи бейджей (архитектура, flow, примеры PL/pgSQL)

**Flow:**
1. Событие (например, shift завершён) вызывает функцию проверки условий бейджа.
2. Если условия выполнены, бейдж присваивается пользователю (запись в user_badges).
3. При ручной выдаче — работодатель выбирает бейдж и кандидата, указывает причину.

**Пример автоматической выдачи (PL/pgSQL):**
```sql
create or replace function assign_shift_badge()
returns trigger as $$
begin
  if NEW.shifts_count >= 50 then
    insert into user_badges (id, badge_id, user_id, employer_id, source)
    select gen_random_uuid(), b.id, NEW.user_id, NEW.employer_id, 'auto'
    from badges b
    where b.name = '50 Shifts' and (b.company_id = NEW.employer_id or b.company_id is null)
    on conflict do nothing;
  end if;
  return NEW;
end;
$$ language plpgsql;

create trigger work_log_badge_trigger
after insert or update on work_logs
for each row execute function assign_shift_badge();
```

## 7. Автогенерация бейджей от компаний

- Работодатель может создавать собственные шаблоны бейджей (с SVG-иконкой, названием, условиями).
- Бейджи компании видны только внутри этой компании, если не отмечены как публичные.
- Автоматические правила (например, “10 смен подряд без опозданий”) настраиваются через UI или админ-панель.

## 8. UI-компоненты и UX-поведение

**Основные блоки:**
1. **Видео-портфолио** — короткое приветствие (до 15 сек), загрузка/съёмка, предпросмотр, хранение в облаке.
2. **Информация о кандидате** — имя, должность, краткое описание, аватар.
3. **Бейджи** — горизонтальная лента с прокруткой, фильтры по категориям/уровням, всплывающее окно с деталями.
4. **Шкалы навыков** — визуализация прогресса (цветные полосы, 0–100%), формируются на основе бейджей и подтверждений.
5. **Лента опыта** — таймлайн/карточки: логотип заведения, период, количество смен, бейджи, быстрый просмотр видео/отзывов.

**UX:**
- Минимум текста, максимум визуала.
- Быстрый доступ к видео и бейджам.
- Клик по бейджу — подробности, история получения, кто выдал.
- Адаптивность (mobile-first).
- Интеграция с соцсетями для автозагрузки видео.

## 9. API/RPC/Edge Functions

- `POST /badges/assign` — вручить бейдж (ручная/автоматическая выдача).
- `GET /users/{id}/badges` — список бейджей пользователя.
- `POST /badges/company-create` — создание бейджа компанией.
- `GET /badges/catalog` — каталог всех доступных бейджей.
- `GET /skills/{user_id}` — шкалы навыков пользователя.
- Edge Function для автоматической выдачи по событиям (смена завершена, подтверждён навык, получена рекомендация).

## 10. RLS и безопасность

- Кандидаты видят только свои данные.
- Работодатель видит только свои бейджи и сотрудников.
- Админ — полный доступ.
- RLS-политики на `user_badges`, `badges`, `skills`, `work_logs`.

**Пример RLS для user_badges:**
```sql
create policy "User can see own badges"
on user_badges
for select
using (user_id = auth.uid());
```

## 11. Нотификации

- Push/web/push-уведомления о новых бейджах.
- Email-уведомления (опционально) при выдаче ключевых бейджей (например, “Gold”).
- Внутренний inbox/уведомления в приложении.

## 12. Backfill для существующих пользователей

- Скрипты для ретроспективного анализа work_logs, skills и выдачи бейджей по историческим данным.
- Возможность ручного подтверждения бейджей администраторами.

## 13. Тестирование и QA

- Unit-тесты для функций выдачи бейджей.
- Интеграционные тесты API.
- UI-тесты (визуализация бейджей, шкал, видео).
- Проверка RLS, сценариев edge case.

## 14. Метрики и мониторинг

- Количество выданных бейджей по категориям/уровням.
- Среднее время до получения первого бейджа.
- Вовлечённость (доля пользователей с бейджами, с видео).
- Ошибки автоматической выдачи.

## 15. Acceptance criteria

- Все типы бейджей корректно отображаются и выдаются.
- UI соответствует мокапам, адаптивен.
- Видео загружается, проигрывается, корректно хранится.
- RLS не допускает утечек данных.
- Работодатели могут создавать и назначать собственные бейджи.
- Бейджи влияют на шкалы навыков.

## 16. Roadmap

1. Проработка структуры бейджей и базы данных.
2. Реализация автоматической и ручной выдачи.
3. UI: видео, бейджи, шкалы, опыт.
4. Автогенерация и каталог бейджей.
5. Интеграция нотификаций.
6. RLS и безопасность.
7. Backfill, тестирование, релиз.

## 17. Примеры payloads, SQL и SVG

**Пример payload для выдачи бейджа:**
```json
{
  "badge_id": "uuid",
  "user_id": "uuid",
  "employer_id": "uuid",
  "awarded_by": "uuid",
  "reason": "Отличная работа в ночные смены",
  "source": "manual"
}
```

**SVG (иконка бейджа):**
```svg
<svg width="32" height="32" viewBox="0 0 32 32">
  <circle cx="16" cy="16" r="16" fill="#FFD700"/>
  <text x="16" y="21" font-size="12" text-anchor="middle" fill="#fff">G</text>
</svg>
```

**SQL для выборки всех Gold-бейджей пользователя:**
```sql
select b.*, ub.awarded_at
from user_badges ub
join badges b on ub.badge_id = b.id
where ub.user_id = :user_id and b.level = 'Gold';
```

## 18. Edge case рекомендации

- Повторная выдача одного и того же бейджа: запрещать или вести историю?
- Отображение скрытых/непубличных бейджей.
- Массовая выдача (bulk) при миграции.
- Конфликт категорий или уровней (например, Gold и Silver одного типа).
- Удаление/отзыв бейджа (audit trail).
- Несовпадение бейджа и уровня навыка — как синхронизировать.

## 19. Вопросы для уточнения

1. Может ли один бейдж иметь несколько категорий? (например, “Barista” = Hard Skills + Опыт)
2. Допускаются ли временные/ограниченные по сроку действия бейджи?
3. Нужно ли отображать бейджи, выданные неактуальными работодателями?
4. Как отображать прогресс до следующего уровня бейджа?
5. Поддержка кастомных SVG/иконок от компаний или только из каталога?
6. Могут ли кандидаты скрывать отдельные бейджи?
7. Как реализовать отзыв/аннулирование бейджей?
8. Поддержка мульти-язычности названий/описаний бейджей?
9. Требуется ли версионирование бейджей (например, обновление иконки, описания)?
10. Как синхронизировать шкалы навыков и бейджи при изменении логики?
11. Могут ли работодатели видеть бейджи, выданные другими компаниями?
12. Как реализовать массовую выдачу/отзыв бейджей (bulk)?
13. Требуется ли интеграция с внешними системами для подтверждения навыков?
14. Какие лимиты на количество бейджей у пользователя?
15. Как визуализировать “редкие” или “легендарные” бейджи?
16. Нужно ли хранить историю изменений по бейджу/выдаче?
17. Как отображать бейджи в публичном профиле (по умолчанию/по выбору)?
18. Требуется ли экспорт/импорт бейджей между компаниями?
19. Как обрабатывать edge-cases с удалёнными работодателями или невалидными бейджами?